{% extends "layouts/grantManagement.html" %}

{% set navID = 'grantReports' %}
{% set showBackLink = false %}
{% set showBackApplicationsLink = false %}

{% set pageSize = "l" %}
{% set pageHeading = "Manage task" %}
{% if isUnassignedTask or data.isUnassignedTask %}
    {% set pageSection = "Unassigned task" %}
{% else %}
    {% set pageSection = '' + (sectionName or data.sectionName) + '' %}
{% endif %}
{% set pageHiddentext = "yes" %}
{% set pageNested = "yes" %}

{% block pageTitle %}{{ macroPageTitle.pageTitle(pageHeading) }}{% endblock %}

{% block content %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        {# Template-based breadcrumbs for questions page #}
        {% set breadcrumbItems = [] %}
        {% set breadcrumbItems = (breadcrumbItems.push({
            text: "Reports",
            href: "/funding/grant/reports/"
        }), breadcrumbItems) %}

        {% if reportName or data.reportName %}
            {% set breadcrumbItems = (breadcrumbItems.push({
                text: reportName or data.reportName,
                href: "/funding/grant/reports/sections?reportId=" + (currentReportId or data.currentReportId)
            }), breadcrumbItems) %}
        {% endif %}

        {% set breadcrumbItems = (breadcrumbItems.push({
            text: "Tasks",
            href: "/funding/grant/reports/sections?reportId=" + (currentReportId or data.currentReportId)
        }), breadcrumbItems) %}

        {% if taskName or data.taskName %}
            {% set breadcrumbItems = (breadcrumbItems.push({
                text: taskName or data.taskName
            }), breadcrumbItems) %}
        {% endif %}

        {{ govukBreadcrumbs({
            items: breadcrumbItems,
            classes: "govuk-!-margin-bottom-6"
        }) }}

        {# Show question delete confirmation banner if questionDeleteConfirm parameter is present #}
        {% if questionDeleteConfirm %}
            {% set deleteQuestionName = deleteQuestionName or 'this question' %}
            {% set html %}
                <p class="govuk-notification-banner__heading">
                    Are you sure you want to delete ‘{{ deleteQuestionName }}’?
                </p>
                <p class="govuk-body govuk-button-group">
                    {% if isUnassignedTask or data.isUnassignedTask %}
                        <a class="govuk-button govuk-button--warning" href="/funding/grant/reports/questions/delete/{{ deleteQuestionId }}?reportId={{ currentReportId or data.currentReportId }}&taskId={{ currentTaskId or data.currentTaskId }}&unassigned=true&confirm=yes">Yes, delete this question</a>
                        <a class="govuk-notification-banner__link" href="/funding/grant/reports/questions?reportId={{ currentReportId or data.currentReportId }}&taskId={{ currentTaskId or data.currentTaskId }}&unassigned=true&cancel=true">Cancel</a>
                    {% else %}
                        <a class="govuk-button govuk-button--warning" href="/funding/grant/reports/questions/delete/{{ deleteQuestionId }}?reportId={{ currentReportId or data.currentReportId }}&sectionId={{ currentSectionId or data.currentSectionId }}&taskId={{ currentTaskId or data.currentTaskId }}&confirm=yes">Yes, delete this question</a>
                        <a class="govuk-notification-banner__link" href="/funding/grant/reports/questions?reportId={{ currentReportId or data.currentReportId }}&sectionId={{ currentSectionId or data.currentSectionId }}&taskId={{ currentTaskId or data.currentTaskId }}&cancel=true">Cancel</a>
                    {% endif %}
                </p>
            {% endset %}
            {{ govukNotificationBanner({
                html: html,
                type: "warning",
                titleText: "Important",
                classes: "app-notification-banner--destructive"
            }) }}
        {% endif %}

        {# Show task delete confirmation banner if taskDeleteConfirm parameter is present #}
        {% if taskDeleteConfirm %}
            {% set deleteTaskName = deleteTaskName or 'this task' %}
            {% set html %}
                <p class="govuk-notification-banner__heading">
                    Are you sure you want to delete ‘{{ deleteTaskName }}’?
                </p>
                <p class="govuk-body govuk-button-group">
                    {% if isUnassignedTask or data.isUnassignedTask %}
                        <a class="govuk-button govuk-button--warning" href="/funding/grant/reports/unassigned-tasks/delete/{{ deleteTaskId }}?reportId={{ currentReportId or data.currentReportId }}&confirm=yes">Yes, delete this task</a>
                        <a class="govuk-link govuk-link--no-visited-state" href="/funding/grant/reports/questions?reportId={{ currentReportId or data.currentReportId }}&taskId={{ currentTaskId or data.currentTaskId }}&unassigned=true&cancel=true">Cancel</a>
                    {% else %}
                        <a class="govuk-button govuk-button--warning" href="/funding/grant/reports/tasks/delete/{{ deleteTaskId }}?reportId={{ currentReportId or data.currentReportId }}&sectionId={{ currentSectionId or data.currentSectionId }}&confirm=yes">Yes, delete this task</a>
                        <a class="govuk-link govuk-link--no-visited-state" href="/funding/grant/reports/questions?reportId={{ currentReportId or data.currentReportId }}&sectionId={{ currentSectionId or data.currentSectionId }}&taskId={{ currentTaskId or data.currentTaskId }}&cancel=true">Cancel</a>
                    {% endif %}
                </p>
            {% endset %}
            {{ govukNotificationBanner({
                html: html,
                type: "warning",
                titleText: "Important",
                classes: "app-notification-banner--destructive"
            }) }}
        {% endif %}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                {{ macroPageHeader.pageHeader(pageNested,pageHeading,pageSection,pageHiddentext,pageSize) }}
            </div>
        </div>

        {# Task information summary list - simplified to show task name in first column #}
        {% set taskActions = [] %}
        
        {# Always show "Change name" first - handle both regular and unassigned tasks #}
        {% if isUnassignedTask or data.isUnassignedTask %}
            {% set changeNameHref = "/funding/grant/reports/edit/task/?taskId=" + (currentTaskId or data.currentTaskId) + "&reportId=" + (currentReportId or data.currentReportId) + "&unassigned=true" %}
        {% else %}
            {% set changeNameHref = "/funding/grant/reports/edit/task/?taskId=" + (currentTaskId or data.currentTaskId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&reportId=" + (currentReportId or data.currentReportId) %}
        {% endif %}

        {% set taskActions = (taskActions.push({
            href: changeNameHref,
            text: "Change name",
            visuallyHiddenText: "of task",
            classes: "govuk-link govuk-link--no-visited-state"
        }), taskActions) %}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">

        {{ govukSummaryList({
            rows: [
                {
                    key: { text: taskName or data.taskName },
                    actions: {
                        classes: "govuk-!-width-one-half",
                        items: taskActions
                    }
                }
            ],
            classes: "govuk-!-margin-bottom-7"
        }) }}

        </div>
        </div>

        {% if (currentQuestions or data.currentQuestions) and (currentQuestions or data.currentQuestions).length > 0 %}
            {% set questionCount = (currentQuestions or data.currentQuestions).length %}

            {# Build the questions summary list rows #}
            {% set questionRows = [] %}

            {# Add individual question rows #}
            {% for question in (currentQuestions or data.currentQuestions) %}
                {% set questionIndex = loop.index0 %}  {# Get the current question index (0-based) #}
                {% set isFirstQuestion = (questionIndex == 0) %}
                {% set isLastQuestion = (questionIndex == (questionCount - 1)) %}

                {# Build move up/down, edit and delete URLs based on task type #}
                {% if isUnassignedTask or data.isUnassignedTask %}
                    {% set moveUpHref = "/funding/grant/reports/questions/move-up/" + question.id + "?reportId=" + (currentReportId or data.currentReportId) + "&taskId=" + (currentTaskId or data.currentTaskId) + "&unassigned=true" %}
                    {% set moveDownHref = "/funding/grant/reports/questions/move-down/" + question.id + "?reportId=" + (currentReportId or data.currentReportId) + "&taskId=" + (currentTaskId or data.currentTaskId) + "&unassigned=true" %}
                    {% set editHref = "/funding/grant/reports/edit/question/?questionId=" + question.id + "&taskId=" + (currentTaskId or data.currentTaskId) + "&reportId=" + (currentReportId or data.currentReportId) + "&unassigned=true" %}
                    {% set deleteHref = "/funding/grant/reports/questions/?reportId=" + (currentReportId or data.currentReportId) + "&taskId=" + (currentTaskId or data.currentTaskId) + "&unassigned=true&questionDeleteConfirm=true&deleteQuestionId=" + question.id + "&deleteQuestionName=" + question.questionName %}
                {% else %}
                    {% set moveUpHref = "/funding/grant/reports/questions/move-up/" + question.id + "?reportId=" + (currentReportId or data.currentReportId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&taskId=" + (currentTaskId or data.currentTaskId) %}
                    {% set moveDownHref = "/funding/grant/reports/questions/move-down/" + question.id + "?reportId=" + (currentReportId or data.currentReportId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&taskId=" + (currentTaskId or data.currentTaskId) %}
                    {% set editHref = "/funding/grant/reports/edit/question/?questionId=" + question.id + "&taskId=" + (currentTaskId or data.currentTaskId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&reportId=" + (currentReportId or data.currentReportId) %}
                    {% set deleteHref = "/funding/grant/reports/questions/?reportId=" + (currentReportId or data.currentReportId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&taskId=" + (currentTaskId or data.currentTaskId) + "&questionDeleteConfirm=true&deleteQuestionId=" + question.id + "&deleteQuestionName=" + question.questionName %}
                {% endif %}

                {# Build actions array conditionally - only include active actions #}
                {% set questionActions = [] %}

                {# Only add Move Up if not first question and there are multiple questions #}
                {% if questionCount > 1 and not isFirstQuestion %}
                    {% set questionActions = (questionActions.push({
                        href: moveUpHref,
                        text: "Move up",
                        visuallyHiddenText: question.questionName,
                        classes: "govuk-link govuk-link--no-visited-state"
                    }), questionActions) %}
                {% endif %}

                {# Only add Move Down if not last question and there are multiple questions #}
                {% if questionCount > 1 and not isLastQuestion %}
                    {% set questionActions = (questionActions.push({
                        href: moveDownHref,
                        text: "Move down",
                        visuallyHiddenText: question.questionName,
                        classes: "govuk-link govuk-link--no-visited-state"
                    }), questionActions) %}
                {% endif %}

                {# Always add Edit #}
                {% set questionActions = (questionActions.push({
                    href: editHref,
                    text: "Edit",
                    visuallyHiddenText: question.questionName,
                    classes: "govuk-link govuk-link--no-visited-state"
                }), questionActions) %}

                {# Always add Delete #}
                {% set questionActions = (questionActions.push({
                    href: deleteHref,
                    text: "Delete",
                    visuallyHiddenText: question.questionName,
                    classes: "govuk-link govuk-link--no-visited-state govuk-link--destructive"
                }), questionActions) %}

                {% set questionRow = {
                    key: {
                        text: question.questionName,
                        classes: "govuk-!-font-weight-regular govuk-!-width-one-half"
                    },
                    actions: {
                        classes: "govuk-!-width-one-half",
                        items: questionActions
                    }
                } %}
                {% set questionRows = (questionRows.push(questionRow), questionRows) %}
            {% endfor %}

            {{ govukSummaryList({
                rows: questionRows,
                classes: "govuk-!-margin-bottom-7"
            }) }}

            {# Add question button below the questions list #}
            {% if isUnassignedTask or data.isUnassignedTask %}
                {% set addQuestionHref = "/funding/grant/reports/add/question/?taskId=" + (currentTaskId or data.currentTaskId) + "&reportId=" + (currentReportId or data.currentReportId) + "&unassigned=true" %}
                {% set deleteTaskHref = "/funding/grant/reports/questions/?reportId=" + (currentReportId or data.currentReportId) + "&taskId=" + (currentTaskId or data.currentTaskId) + "&unassigned=true&taskDeleteConfirm=true&deleteTaskId=" + (currentTaskId or data.currentTaskId) + "&deleteTaskName=" + (taskName or data.taskName) %}
            {% else %}
                {% set addQuestionHref = "/funding/grant/reports/add/question/?taskId=" + (currentTaskId or data.currentTaskId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&reportId=" + (currentReportId or data.currentReportId) %}
                {% set deleteTaskHref = "/funding/grant/reports/questions/?reportId=" + (currentReportId or data.currentReportId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&taskId=" + (currentTaskId or data.currentTaskId) + "&taskDeleteConfirm=true&deleteTaskId=" + (currentTaskId or data.currentTaskId) + "&deleteTaskName=" + (taskName or data.taskName) %}
            {% endif %}

            <div class="govuk-button-group">
                {{ govukButton({
                    text: "Add question",
                    href: addQuestionHref,
                    classes: "govuk-button--secondary"
                }) }}

                {{ govukButton({
                    text: "Delete task",
                    href: deleteTaskHref,
                    classes: "govuk-button--warning"
                }) }}
            </div>
        {% else %}
            {# No questions exist yet #}
            {% if isUnassignedTask or data.isUnassignedTask %}
                {% set addQuestionHref = "/funding/grant/reports/add/question/?taskId=" + (currentTaskId or data.currentTaskId) + "&reportId=" + (currentReportId or data.currentReportId) + "&unassigned=true" %}
                {% set deleteTaskHref = "/funding/grant/reports/questions/?reportId=" + (currentReportId or data.currentReportId) + "&taskId=" + (currentTaskId or data.currentTaskId) + "&unassigned=true&taskDeleteConfirm=true&deleteTaskId=" + (currentTaskId or data.currentTaskId) + "&deleteTaskName=" + (taskName or data.taskName) %}
            {% else %}
                {% set addQuestionHref = "/funding/grant/reports/add/question/?taskId=" + (currentTaskId or data.currentTaskId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&reportId=" + (currentReportId or data.currentReportId) %}
                {% set deleteTaskHref = "/funding/grant/reports/questions/?reportId=" + (currentReportId or data.currentReportId) + "&sectionId=" + (currentSectionId or data.currentSectionId) + "&taskId=" + (currentTaskId or data.currentTaskId) + "&taskDeleteConfirm=true&deleteTaskId=" + (currentTaskId or data.currentTaskId) + "&deleteTaskName=" + (taskName or data.taskName) %}
            {% endif %}

            <p class="govuk-body">There are no questions in this task yet.</p>

            <div class="govuk-button-group">
                {{ govukButton({
                    text: "Add questions",
                    href: addQuestionHref,
                    classes: "govuk-button--secondary"
                }) }}

                {{ govukButton({
                    text: "Delete task",
                    href: deleteTaskHref,
                    classes: "govuk-button--warning"
                }) }}
            </div>
        {% endif %}

    </div>
</div>

{% endblock %}
