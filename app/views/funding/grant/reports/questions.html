{% extends "layouts/grantManagement.html" %}

{% set navID = 'grantReports' %}
{% set showBackLink = false %}
{% set showBackApplicationsLink = false %}

{% set pageSize = "l" %}
{% set pageHeading = "Manage questions" %}
{% set pageSection = '' + data['taskName'] + '' %}
{% set pageHiddentext = "yes" %}
{% set pageNested = "yes" %}

{% block pageTitle %}{{ macroPageTitle.pageTitle(pageHeading) }}{% endblock %}

{% block content %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        {# Template-based breadcrumbs for questions page #}
        {% set breadcrumbItems = [] %}
        {% set breadcrumbItems = (breadcrumbItems.push({
            text: "Reports",
            href: "/funding/grant/reports/"
        }), breadcrumbItems) %}

        {% if data.reportName %}
            {% set breadcrumbItems = (breadcrumbItems.push({
                text: data.reportName,
                href: "/funding/grant/reports/sections?reportId=" + data.currentReportId
            }), breadcrumbItems) %}
        {% endif %}

        {% set breadcrumbItems = (breadcrumbItems.push({
            text: "Sections and tasks",
            href: "/funding/grant/reports/sections?reportId=" + data.currentReportId
        }), breadcrumbItems) %}

        {% if data.taskName %}
            {% set breadcrumbItems = (breadcrumbItems.push({
                text: data.taskName
            }), breadcrumbItems) %}
        {% endif %}

        {{ govukBreadcrumbs({
            items: breadcrumbItems,
            classes: "govuk-!-margin-bottom-6"
        }) }}

        {# Show question delete confirmation banner if questionDeleteConfirm parameter is present #}
        {% if data.questionDeleteConfirm %}
            {% set deleteQuestionName = data.deleteQuestionName or 'this question' %}
            {% set html %}
                <p class="govuk-notification-banner__heading">
                    Are you sure you want to delete "{{ deleteQuestionName }}"?
                </p>
                <p class="govuk-body">
                    <a class="govuk-notification-banner__link" href="/funding/grant/reports/questions/delete/{{ data.deleteQuestionId }}?reportId={{ data.currentReportId }}&sectionId={{ data.currentSectionId }}&taskId={{ data.currentTaskId }}&confirm=yes">Yes, delete this question</a>
                    <a class="govuk-notification-banner__link govuk-!-margin-left-4" href="/funding/grant/reports/questions?reportId={{ data.currentReportId }}&sectionId={{ data.currentSectionId }}&taskId={{ data.currentTaskId }}&cancel=true">Cancel</a>
                </p>
            {% endset %}
            {{ govukNotificationBanner({
                html: html,
                type: "warning",
                titleText: "Important"
            }) }}
        {% endif %}

        {# Show task delete confirmation banner if taskDeleteConfirm parameter is present #}
        {% if data.taskDeleteConfirm %}
            {% set deleteTaskName = data.deleteTaskName or 'this task' %}
            {% set html %}
                <p class="govuk-notification-banner__heading">
                    Are you sure you want to delete "{{ deleteTaskName }}"?
                </p>
                <p class="govuk-body">
                    {% if data.isUnassignedTask %}
                        <a class="govuk-notification-banner__link" href="/funding/grant/reports/unassigned-tasks/delete/{{ data.deleteTaskId }}?reportId={{ data.currentReportId }}&confirm=yes">Yes, delete this task</a>
                    {% else %}
                        <a class="govuk-notification-banner__link" href="/funding/grant/reports/tasks/delete/{{ data.deleteTaskId }}?reportId={{ data.currentReportId }}&sectionId={{ data.currentSectionId }}&confirm=yes">Yes, delete this task</a>
                    {% endif %}
                    <a class="govuk-notification-banner__link govuk-!-margin-left-4" href="/funding/grant/reports/questions?reportId={{ data.currentReportId }}&sectionId={{ data.currentSectionId }}&taskId={{ data.currentTaskId }}&cancel=true">Cancel</a>
                </p>
            {% endset %}
            {{ govukNotificationBanner({
                html: html,
                type: "warning",
                titleText: "Important"
            }) }}
        {% endif %}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                {{ macroPageHeader.pageHeader(pageNested,pageHeading,pageSection,pageHiddentext,pageSize) }}
            </div>
        </div>

        {% if data.currentQuestions and data.currentQuestions.length > 0 %}
            {% set questionCount = data.currentQuestions.length %}

            {# Build the questions summary list rows #}
            {% set questionRows = [] %}

            {# Add individual question rows #}
            {% for question in data.currentQuestions %}
                {% set questionRow = {
                    key: {
                        text: question.questionName,
                        classes: "govuk-!-font-weight-regular"
                    },
                    value: {
                        text: question.questionType
                    },
                    actions: {
                        classes: "govuk-!-width-one-third",
                        items: [
                            {
                                href: "/funding/grant/reports/questions/move-up/" + question.id + "?reportId=" + data.currentReportId + "&sectionId=" + data.currentSectionId + "&taskId=" + data.currentTaskId,
                                text: "Move up",
                                visuallyHiddenText: question.questionName,
                                classes: "govuk-link govuk-link--no-visited-state"
                            },
                            {
                                href: "/funding/grant/reports/questions/move-down/" + question.id + "?reportId=" + data.currentReportId + "&sectionId=" + data.currentSectionId + "&taskId=" + data.currentTaskId,
                                text: "Move down",
                                visuallyHiddenText: question.questionName,
                                classes: "govuk-link govuk-link--no-visited-state"
                            },
                            {
                                href: "/funding/grant/reports/questions/?reportId=" + data.currentReportId + "&sectionId=" + data.currentSectionId + "&taskId=" + data.currentTaskId + "&questionDeleteConfirm=true&deleteQuestionId=" + question.id + "&deleteQuestionName=" + question.questionName,
                                text: "Delete",
                                visuallyHiddenText: question.questionName,
                                classes: "govuk-link govuk-link--no-visited-state govuk-link--destructive"
                            }
                        ]
                    }
                } %}
                {% set questionRows = (questionRows.push(questionRow), questionRows) %}
            {% endfor %}

            {# Add "Add another question" row at the end #}
            {% set addQuestionRow = {
                key: {
                    html: '<a href="/funding/grant/reports/add/question/?taskId=' + data.currentTaskId + '&sectionId=' + data.currentSectionId + '&reportId=' + data.currentReportId + '" class="govuk-link govuk-link--no-visited-state">Add another question</a>',
                    classes: "govuk-!-font-weight-regular"
                },
                value: {
                    html: ""
                }
            } %}
            {% set questionRows = (questionRows.push(addQuestionRow), questionRows) %}

            {# Build task card actions - Change name, Heading group (for unassigned tasks), Delete action #}
            {% set taskActions = [] %}
            
            {# Always show "Change name" first #}
            {% set taskActions = (taskActions.push({
                href: "/funding/grant/reports/edit/task/?taskId=" + data.currentTaskId + "&sectionId=" + data.currentSectionId + "&reportId=" + data.currentReportId,
                text: "Change name",
                visuallyHiddenText: "of task",
                classes: "govuk-link govuk-link--no-visited-state"
            }), taskActions) %}
            
            {# Only show "Heading group" if this is an unassigned task #}
            {% if data.isUnassignedTask %}
                {% set taskActions = (taskActions.push({
                    href: "#",
                    text: "Heading group",
                    visuallyHiddenText: "task",
                    classes: "govuk-link govuk-link--no-visited-state"
                }), taskActions) %}
            {% endif %}
            
            {# Always show "Delete" last #}
            {% set taskActions = (taskActions.push({
                href: "/funding/grant/reports/questions/?reportId=" + data.currentReportId + "&sectionId=" + data.currentSectionId + "&taskId=" + data.currentTaskId + "&taskDeleteConfirm=true&deleteTaskId=" + data.currentTaskId + "&deleteTaskName=" + data.taskName,
                text: "Delete",
                visuallyHiddenText: "task",
                classes: "govuk-link govuk-link--no-visited-state govuk-link--destructive"
            }), taskActions) %}

            {{ govukSummaryList({
                card: {
                    title: { text: data.taskName },
                    classes: "govuk-!-margin-top-7 govuk-!-margin-bottom-7",
                    actions: {
                        items: taskActions
                    }
                },
                rows: questionRows
            }) }}
        {% else %}
            {# No questions exist yet #}
            {% set noQuestionsRow = {
                key: {
                    html: '<a href="/funding/grant/reports/add/question/?taskId=' + data.currentTaskId + '&sectionId=' + data.currentSectionId + '&reportId=' + data.currentReportId + '" class="govuk-link govuk-link--no-visited-state">Add questions to this task</a>',
                    classes: "govuk-!-font-weight-regular"
                },
                value: {
                    html: ""
                }
            } %}

            {# Build task card actions for empty state - include Group under heading (for unassigned tasks) and Delete action #}
            {% set taskActions = [] %}
            
            {# Only show "Heading group" if this is an unassigned task #}
            {% if data.isUnassignedTask %}
                {% set taskActions = (taskActions.push({
                    href: "#",
                    text: "Heading group",
                    visuallyHiddenText: "task",
                    classes: "govuk-link govuk-link--no-visited-state"
                }), taskActions) %}
            {% endif %}
            
            {% set taskActions = (taskActions.push({
                href: "/funding/grant/reports/questions/?reportId=" + data.currentReportId + "&sectionId=" + data.currentSectionId + "&taskId=" + data.currentTaskId + "&taskDeleteConfirm=true&deleteTaskId=" + data.currentTaskId + "&deleteTaskName=" + data.taskName,
                text: "Delete",
                visuallyHiddenText: "task",
                classes: "govuk-link govuk-link--no-visited-state govuk-link--destructive"
            }), taskActions) %}

            {{ govukSummaryList({
                card: {
                    title: { text: data.taskName },
                    classes: "govuk-!-margin-top-7 govuk-!-margin-bottom-7",
                    actions: {
                        items: taskActions
                    }
                },
                rows: [noQuestionsRow]
            }) }}
        {% endif %}

    </div>
</div>

{% endblock %}