{% extends "layouts/reports.html" %}

{% set navID = 'grantReports' %}
{% set showBackLink = false %}

{% set pageSize = "l" %}
{% set pageHeading = "Reports" %}
{% set pageSection = '' + data['grantName'] + '' %}
{% set pageHiddentext = "yes" %}
{% set pageNested = "yes" %}

{% block pageTitle %}{{ macroPageTitle.pageTitle(pageHeading) }}{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        {# Template-based breadcrumbs for reports page #}
        {% set breadcrumbItems = [] %}
        {% set breadcrumbItems = (breadcrumbItems.push({ text: "Reports" }), breadcrumbItems) %}

        {# Reports page only shows breadcrumbs if there are multiple levels (which there aren't) #}
        {# So breadcrumbs won't show on reports page - this is correct #}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">

                {{ macroPageHeader.pageHeader(pageNested,pageHeading,pageSection,pageHiddentext,pageSize) }}

                {% if not data.reports or data.reports.length == 0 %}
                    <p class="govuk-body">There are no monitoring reports for {{ data.grantName or "NAME of GRANT" }}. Add a monitoring report to get started.</p>
                    <p class="govuk-body"><a href="#">See an example of a monitoring report form (opens in new tab)</a> and a description of the component parts of a form.</p>
                {% else %}
                    <p class="govuk-body"><a href="#">See an example of a monitoring report form (opens in new tab)</a> and a description of the component parts of a form.</p>
                {% endif %}

                <a href="/funding/grant/reports/new" class="govuk-button govuk-!-margin-top-5">
                    {% if data.reports and data.reports.length > 0 %}
                        Add another monitoring report
                    {% else %}
                        Add a monitoring report
                    {% endif %}
                </a>
            </div>
        </div>

        {% if data.reports and data.reports.length > 0 %}

            {% for report in data.reports %}
                {% if report.sections %}
                    {% set sectionCount = report.sections.length %}
                {% else %}
                    {% set sectionCount = 0 %}
                {% endif %}

                {% if report.unassignedTasks %}
                    {% set unassignedTaskCount = report.unassignedTasks.length %}
                {% else %}
                    {% set unassignedTaskCount = 0 %}
                {% endif %}

                {% if sectionCount == 0 and unassignedTaskCount == 0 %}
                    {# No sections or tasks yet - show task option only #}
                    {% set sectionsText = '<a href="/funding/grant/reports/add/task/?reportId=' + report.id + '" class="govuk-link govuk-link--no-visited-state">Add tasks</a> to create your form <br>Tasks are groups of questions with a common theme' %}
                    {% set sectionsRow = {
                        key: { text: "Form" },
                        value: { html: sectionsText }
                    } %}

                {% elif sectionCount == 0 and unassignedTaskCount > 0 %}
                    {# Only unassigned tasks exist - show manage link #}
                    {% set sectionsText = '<a href="/funding/grant/reports/' + report.id + '/sections" class="govuk-link govuk-link--no-visited-state">Manage tasks</a>' %}
                    {% set sectionsRow = {
                        key: { text: "Form" },
                        value: { html: sectionsText }
                    } %}

                {% elif sectionCount > 0 %}
                    {# Sections exist - show normal manage sections link #}
                    {% set sectionsText = '<a href="/funding/grant/reports/' + report.id + '/sections" class="govuk-link govuk-link--no-visited-state">Manage tasks</a>' %}

                    {% set sectionsRow = {
                        key: { text: "Form" },
                        value: { html: sectionsText }
                    } %}
                {% endif %}

                {{ govukSummaryList({
                    card: {
                        title: { text: report.reportName or "Form name" },
                        classes: "govuk-!-margin-top-7 govuk-!-margin-bottom-7",
                        actions: {
                            items: [
                                {
                                    href: "#",
                                    classes: "govuk-link govuk-link--no-visited-state",
                                    text: "Preview",
                                    visuallyHiddenText: "report"
                                },
                                {
                                    href: "/funding/grant/reports/" + report.id + "/edit",
                                    classes: "govuk-link govuk-link--no-visited-state",
                                    text: "Change name",
                                    visuallyHiddenText: "of report"
                                },
                                {
                                    href: "/funding/grant/reports/" + report.id + "/delete",
                                    classes: "govuk-link govuk-link--no-visited-state govuk-link--destructive",
                                    text: "Delete",
                                    visuallyHiddenText: "report"
                                }
                            ]
                        }
                    },
                    rows: [
                        sectionsRow,
                        {
                            key: { text: "Created by" },
                            value: { html: '<a href="#">' + report.createdBy + '</a> on ' + report.createdDate }
                        },
                        {
                            key: { text: "Last updated" },
                            value: { html: '<a href="#">' + report.updatedBy + '</a> on ' + report.lastUpdated }
                        }
                    ]
                }) }}

            {% endfor %}

        {% endif %}

        {% if data['liveReports'] == "yes" %}
            {% include "/includes/reports/live.html" %}
        {% endif %}

    </div>
</div>
{% endblock %}