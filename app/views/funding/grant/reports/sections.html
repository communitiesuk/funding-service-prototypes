{% extends "layouts/grantManagement.html" %}
{% set navID = 'grantReports' %}
{% set showBackLink = false %}
{% set showBackApplicationsLink = false %}
{% set pageSize = "l" %}
{% set pageHeading = "Monitoring report" %}
{% set pageSection = reportName %}
{% set pageHiddentext = "yes" %}
{% set pageNested = "yes" %}
{% block pageTitle %}{{ macroPageTitle.pageTitle(pageHeading) }}{% endblock %}
{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-full">

        {# Template-based breadcrumbs - build directly in template #}
        {% set breadcrumbItems = [] %}
        {% set breadcrumbItems = (breadcrumbItems.push({
            text: "Reports",
            href: "/funding/grant/reports/"
        }), breadcrumbItems) %}

        {% if reportName %}
            {% set breadcrumbItems = (breadcrumbItems.push({
                text: reportName
            }), breadcrumbItems) %}
        {% endif %}

        {% if breadcrumbItems.length > 1 %}
            {{ govukBreadcrumbs({
                items: breadcrumbItems,
                classes: "govuk-!-margin-bottom-6"
            }) }}
        {% endif %}

        {# Show delete confirmation banner if deleteConfirm parameter is present #}
        {% if deleteConfirm %}
            {% set deleteSectionName = deleteSectionName or 'this section' %}
            {% set html %}
                <p class="govuk-notification-banner__heading">
                    Are you sure you want to delete ‘{{ deleteSectionName }}’?
                </p>
                <p class="govuk-body govuk-button-group">
                    <a class="govuk-button govuk-button--warning" href="/funding/grant/reports/sections/delete/{{ deleteSectionId }}?reportId={{ currentReportId }}&confirm=yes">Yes, delete this section</a>
                    <a class="govuk-notification-banner__link" href="/funding/grant/reports/sections?reportId={{ currentReportId }}&cancel=true">Cancel</a>
                </p>
            {% endset %}
            {{ govukNotificationBanner({
                html: html,
                type: "warning",
                titleText: "Important",
                "classes": "app-notification-banner--destructive"
            }) }}
        {% endif %}

        {# Show task delete confirmation banner if taskDeleteConfirm parameter is present #}
        {% if taskDeleteConfirm %}
            {% set deleteTaskName = deleteTaskName or 'this task' %}
            {% set html %}
                <p class="govuk-notification-banner__heading">
                    Are you sure you want to delete '{{ deleteTaskName }}'?
                </p>
                <p class="govuk-body govuk-button-group">
                    {% if deleteTaskSectionId == 'unassigned' %}
                        <a class="govuk-button govuk-button--warning" href="/funding/grant/reports/unassigned-tasks/delete/{{ deleteTaskId }}?reportId={{ currentReportId }}&confirm=yes">Yes, delete this task</a>
                    {% else %}
                        <a class="govuk-notification-banner__link" href="/funding/grant/reports/tasks/delete/{{ deleteTaskId }}?reportId={{ currentReportId }}&sectionId={{ deleteTaskSectionId }}&confirm=yes">Yes, delete this task</a>
                    {% endif %}
                    <a class="govuk-notification-banner__link govuk-!-margin-left-4" href="/funding/grant/reports/sections?reportId={{ currentReportId }}&cancel=true">Cancel</a>
                </p>
            {% endset %}
            {{ govukNotificationBanner({
                html: html,
                type: "destructive",
                titleText: "Important",
                "classes": "app-notification-banner--destructive"
            }) }}
        {% endif %}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
                {{ macroPageHeader.pageHeader(pageNested,pageHeading,pageSection,pageHiddentext,pageSize) }}                
            </div>
            <div class="govuk-grid-column-one-third">
                <div class="govuk-!-text-align-right govuk-!-margin-top-6">
                    {{ govukButton({
                        text: "Preview report",
                        href: "/funding/grant/reports/preview?reportId=" + currentReportId,
                        classes: "govuk-button--secondary"
                    }) }}
                </div>
            </div>
        </div>
        

        {# Show unassigned tasks if any exist #}
        {% if currentUnassignedTasks and currentUnassignedTasks.length > 0 %}
            {# Build the unassigned tasks summary list rows #}
            {% set unassignedRows = [] %}

            {# Add individual unassigned task rows #}
            {% for task in currentUnassignedTasks %}
                {% set taskQuestions = task.questions or [] %}
                {% set questionCount = taskQuestions.length %}
                {% set taskIndex = loop.index0 %}  {# Get the current task index (0-based) #}
                {% set unassignedTaskCount = currentUnassignedTasks.length %}
                {% set isFirstTask = (taskIndex == 0) %}
                {% set isLastTask = (taskIndex == (unassignedTaskCount - 1)) %}

                {% set taskLinkHref = '/funding/grant/reports/questions?taskId=' + task.id + '&reportId=' + currentReportId + '&unassigned=true' %}

                {# Build actions array - only include active actions #}
                {% set unassignedTaskActions = [] %}

                {# Only add Move Up if it should be active #}
                {% if unassignedTaskCount > 1 and not isFirstTask %}
                    {% set unassignedTaskActions = (unassignedTaskActions.push({
                        href: "/funding/grant/reports/unassigned-tasks/move-up/" + task.id + "?reportId=" + currentReportId,
                        text: "Move up",
                        visuallyHiddenText: task.taskName,
                        classes: "govuk-link govuk-link--no-visited-state"
                    }), unassignedTaskActions) %}
                {% endif %}

                {# Only add Move Down if it should be active #}
                {% if unassignedTaskCount > 1 and not isLastTask %}
                    {% set unassignedTaskActions = (unassignedTaskActions.push({
                        href: "/funding/grant/reports/unassigned-tasks/move-down/" + task.id + "?reportId=" + currentReportId,
                        text: "Move down",
                        visuallyHiddenText: task.taskName,
                        classes: "govuk-link govuk-link--no-visited-state"
                    }), unassignedTaskActions) %}
                {% endif %}

                {# Always add Change section action for unassigned tasks #}
                {% set unassignedTaskActions = (unassignedTaskActions.push({
                    href: '/funding/grant/reports/questions?taskId=' + task.id + '&reportId=' + currentReportId + '&unassigned=true',
                    text: "Manage",
                    visuallyHiddenText: task.taskName,
                    classes: "govuk-link govuk-link--no-visited-state"
                }), unassignedTaskActions) %}


								{% set questionHtml %}
									{% if questionCount === 0 %}
										<a class="govuk-link govuk-link--no-visited-state" href="{{ '/funding/grant/reports/add/question?taskId=' + task.id + '&reportId=' + currentReportId + '&unassigned=true'}}">Add questions</a>
									{% else %}
										<a class="govuk-link govuk-link--no-visited-state" href="{{ '/funding/grant/reports/questions?taskId=' + task.id + '&reportId=' + currentReportId + '&unassigned=true'}}">{{ questionCount }} questions</a>
									{% endif %}
								{% endset %}
                {% set unassignedTaskRow = {
                    key: {
                        text: task.taskName,
                        classes: "govuk-!-font-weight-regular"
                    },
                    value: {
                    	html: questionHtml
                    },
                    actions: {
                        classes: "govuk-!-width-one-half",
                        items: unassignedTaskActions
                    }
                } %}
                {% set unassignedRows = (unassignedRows.push(unassignedTaskRow), unassignedRows) %}
            {% endfor %}

            {# Add "Add another task" row at the end #}
            {% set addUnassignedTaskRow = {
                key: {
                    html: '<a href="/funding/grant/reports/add/task/?reportId=' + currentReportId + '" class="govuk-link govuk-link--no-visited-state">Add ' + ("another" if currentUnassignedTasks.length > 0 else "") + ' task</a>',
                    classes: "govuk-!-font-weight-regular govuk-!-margin-top-7"
                },
                value: {
                }
            } %}
            {% set unassignedRows = (unassignedRows.push(addUnassignedTaskRow), unassignedRows) %}

            {{ govukSummaryList({
                card: {
                    title: { text: "Tasks" },
                    classes: "govuk-!-margin-top-7 govuk-!-margin-bottom-7"
                },
                rows: unassignedRows
            }) }}
        {% endif %}

        {# Show sections if any exist #}
        {% if currentSections and currentSections.length > 0 %}
            {% for section in currentSections %}
                {% set sectionTasks = section.tasks or [] %}
                {% set taskCount = sectionTasks.length %}

                {# Build the section summary list rows #}
                {% set sectionRows = [] %}

                {# Tasks rows - each task gets its own row #}
                {% if taskCount == 0 %}
                    {% set tasksRow = {
                        key: {
                            html: '<a href="/funding/grant/reports/add/task/?sectionId=' + section.id + '&reportId=' + currentReportId + '" class="govuk-link govuk-link--no-visited-state">Add task under this section</a>',
                            classes: "govuk-!-font-weight-regular"
                        },
                        value: { html: "" }
                    } %}
                    {% set sectionRows = (sectionRows.push(tasksRow), sectionRows) %}
                {% else %}
                    {# Add individual task rows with conditional disabled states #}
                    {% for task in sectionTasks %}
                        {% set taskQuestions = task.questions or [] %}
                        {% set questionCount = taskQuestions.length %}
                        {% set taskIndex = loop.index0 %}  {# Get the current task index (0-based) #}
                        {% set isFirstTask = (taskIndex == 0) %}
                        {% set isLastTask = (taskIndex == (taskCount - 1)) %}

                        {% set taskLinkHref = '/funding/grant/reports/questions?taskId=' + task.id + '&sectionId=' + section.id + '&reportId=' + currentReportId %}

                        {# Build actions array - only include active actions #}
                        {% set taskActions = [] %}

                        {# Only add Move Up if it should be active #}
                        {% if taskCount > 1 and not isFirstTask %}
                            {% set taskActions = (taskActions.push({
                                href: "/funding/grant/reports/tasks/move-up/" + task.id + "?reportId=" + currentReportId + "&sectionId=" + section.id,
                                text: "Move up",
                                visuallyHiddenText: task.taskName,
                                classes: "govuk-link govuk-link--no-visited-state"
                            }), taskActions) %}
                        {% endif %}

                        {# Only add Move Down if it should be active #}
                        {% if taskCount > 1 and not isLastTask %}
                            {% set taskActions = (taskActions.push({
                                href: "/funding/grant/reports/tasks/move-down/" + task.id + "?reportId=" + currentReportId + "&sectionId=" + section.id,
                                text: "Move down",
                                visuallyHiddenText: task.taskName,
                                classes: "govuk-link govuk-link--no-visited-state"
                            }), taskActions) %}
                        {% endif %}

                        {# Always add Change section action for section tasks #}
                        {% set taskActions = (taskActions.push({
                            href: "/funding/grant/reports/move-task-to-section/?taskId=" + task.id + "&reportId=" + currentReportId + "&currentSectionId=" + section.id,
                            text: "Section",
                            visuallyHiddenText: task.taskName,
                            classes: "govuk-link govuk-link--no-visited-state"
                        }), taskActions) %}

                        {# Always add Delete action for section tasks #}
                        {% set taskActions = (taskActions.push({
                            href: "/funding/grant/reports/sections/?reportId=" + currentReportId + "&taskDeleteConfirm=true&deleteTaskId=" + task.id + "&deleteTaskName=" + task.taskName + "&deleteTaskSectionId=" + section.id,
                            text: "Delete",
                            visuallyHiddenText: task.taskName,
                            classes: "govuk-link govuk-link--no-visited-state govuk-link--destructive"
                        }), taskActions) %}

                        {# Always show "Manage task" link regardless of question count #}
                        {% set linkText = '<a href="/funding/grant/reports/questions?taskId=' + task.id + '&sectionId=' + section.id + '&reportId=' + currentReportId + '" class="govuk-link govuk-link--no-visited-state">Manage task</a>' %}

                        {% set taskRow = {
                            key: {
                                text: task.taskName,
                                classes: "govuk-!-font-weight-regular"
                            },
                            value: {
                                html: linkText
                            },
                            actions: {
                                classes: "govuk-!-width-one-half",
                                items: taskActions
                            }
                        } %}
                        {% set sectionRows = (sectionRows.push(taskRow), sectionRows) %}
                    {% endfor %}

                    {# Add "Add another task" row at the end #}
                    {% set addTaskRow = {
                        key: {
                            html: '<a href="/funding/grant/reports/add/task/?sectionId=' + section.id + '&reportId=' + currentReportId + '" class="govuk-link govuk-link--no-visited-state">Add task</a>',
                            classes: "govuk-!-font-weight-regular govuk-!-padding-top-5"
                        },
                        value: {
                            html: ""
                        }
                    } %}
                    {% set sectionRows = (sectionRows.push(addTaskRow), sectionRows) %}
                {% endif %}

                {# Build section actions array - only include relevant actions #}
                {% set sectionIndex = loop.index0 %}  {# Get current section index (0-based) #}
                {% set sectionCount = currentSections.length %}
                {% set isFirstSection = (sectionIndex == 0) %}
                {% set isLastSection = (sectionIndex == (sectionCount - 1)) %}
                {% set sectionActions = [] %}

                {# Only add Move Up if not the first section and there are multiple sections #}
                {% if sectionCount > 1 and not isFirstSection %}
                    {% set sectionActions = (sectionActions.push({
                        href: "/funding/grant/reports/sections/move-up/" + section.id + "?reportId=" + currentReportId,
                        text: "Move up",
                        visuallyHiddenText: section.sectionName,
                        classes: "govuk-link govuk-link--no-visited-state"
                    }), sectionActions) %}
                {% endif %}

                {# Only add Move Down if not the last section and there are multiple sections #}
                {% if sectionCount > 1 and not isLastSection %}
                    {% set sectionActions = (sectionActions.push({
                        href: "/funding/grant/reports/sections/move-down/" + section.id + "?reportId=" + currentReportId,
                        text: "Move down",
                        visuallyHiddenText: section.sectionName,
                        classes: "govuk-link govuk-link--no-visited-state"
                    }), sectionActions) %}
                {% endif %}

                {# Always add Change name action #}
                {% set sectionActions = (sectionActions.push({
                    href: "/funding/grant/reports/edit/section/?sectionId=" + section.id + "&reportId=" + currentReportId,
                    text: "Change name",
                    visuallyHiddenText: "of " + section.sectionName,
                    classes: "govuk-link govuk-link--no-visited-state"
                }), sectionActions) %}

                {# Always add Delete action #}
                {% set sectionActions = (sectionActions.push({
                    href: "/funding/grant/reports/sections/?reportId=" + currentReportId + "&deleteConfirm=true&deleteSectionId=" + section.id + "&deleteSectionName=" + section.sectionName,
                    text: "Delete",
                    visuallyHiddenText: section.sectionName,
                    classes: "govuk-link govuk-link--no-visited-state govuk-link--destructive"
                }), sectionActions) %}

                {{ govukSummaryList({
                    card: {
                        title: { text: section.sectionName },
                        classes: "govuk-!-margin-top-7 govuk-!-margin-bottom-7",
                        actions: {
                            items: sectionActions
                        }
                    },
                    rows: sectionRows
                }) }}
            {% endfor %}
        {% else %}

        <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">

                {# No sections exist yet #}
                {% if not currentUnassignedTasks or currentUnassignedTasks.length == 0 %}
                    <p class="govuk-body">There are no tasks in this report yet.</p>
                {% endif %}

            </div>
        </div>
            
        {% endif %}

        <div class="govuk-button-group govuk-!-margin-top-1">
            <form method="get" action="/funding/grant/reports/add/section/" class="govuk-!-display-inline-block">
                <input type="hidden" name="reportId" value="{{ currentReportId }}">
                <input type="hidden" name="returnTo" value="sections">
                {% if currentUnassignedTasks and currentUnassignedTasks.length === 0 %}
                    {{ govukButton({
                        text: "Add task",
                        classes: "govuk-button--secondary"
                    }) }}
                {% endif %}
            </form>
        </div>
    </div>
</div>
{% endblock %}
