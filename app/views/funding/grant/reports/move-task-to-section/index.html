{% extends "layouts/grantManagement.html" %}

{% set navID = 'grantReports' %}
{% set showBackLink = true %}

{# Dynamic back link based on task location #}
{% if isUnassigned %}
    {% set backLinkHref = "/funding/grant/reports/questions?taskId=" + taskId + "&reportId=" + reportId + "&unassigned=true" %}
{% else %}
    {% set backLinkHref = "/funding/grant/reports/questions?taskId=" + taskId + "&sectionId=" + currentSectionId + "&reportId=" + reportId %}
{% endif %}

{% set showBackApplicationsLink = false %}
{% set pageSize = "l" %}
{% set pageHeading = "Which heading should this task be grouped under?" %}
{% set pageSection = '' + reportName + '' %}
{% set pageHiddentext = "yes" %}
{% set pageNested = "yes" %}

{% block pageTitle %}{{ macroPageTitle.pageTitle(pageHeading) }}{% endblock %}

{% block content %}
<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        {{ macroPageHeader.pageHeader(pageNested,pageHeading,pageSection,pageHiddentext,pageSize) }}
        
        <p class="govuk-body">Choose which heading you want to group "{{ taskName }}" under. You can select an existing heading or create a new one.</p>
        
        {% if currentSectionName %}
            <p class="govuk-body">This task is currently under the heading "{{ currentSectionName }}".</p>
        {% else %}
            <p class="govuk-body">This task is currently unassigned.</p>
        {% endif %}
        
        <form method="post" action="/funding/grant/reports/move-task-to-section/move">
            {# Hidden fields to maintain context #}
            <input type="hidden" name="taskId" value="{{ taskId }}">
            <input type="hidden" name="reportId" value="{{ reportId }}">
            <input type="hidden" name="currentSectionId" value="{{ currentSectionId }}">
            <input type="hidden" name="isUnassigned" value="{{ isUnassigned }}">
            
            {% set radioItems = [] %}
            
            {# Add existing sections as radio options #}
            {% for section in availableSections %}
                {# Don't show the current section as an option #}
                {% if not currentSectionId or section.id != currentSectionId %}
                    {% set radioItems = (radioItems.push({
                        value: section.id,
                        text: section.sectionName,
                        hint: {
                            text: "Move to existing heading"
                        }
                    }), radioItems) %}
                {% endif %}
            {% endfor %}
            
            {# Add option to create a new section #}
            {% set radioItems = (radioItems.push({
                value: "new-section",
                text: "Create a new heading",
                hint: {
                    text: "Add a new heading and move the task there"
                },
                conditional: {
                    html: govukInput({
                        id: "newSectionName",
                        name: "newSectionName",
                        label: {
                            text: "Heading name",
                            classes: "govuk-label--s"
                        },
                        hint: {
                            text: "Enter the name for the new heading"
                        },
                        classes: "govuk-!-width-two-thirds",
                        attributes: {
                            "spellcheck": "false"
                        }
                    })
                }
            }), radioItems) %}
            
            {# Add option to remove from section (make unassigned) if currently in a section #}
            {% if not isUnassigned %}
                {% set radioItems = (radioItems.push({
                    value: "unassigned",
                    text: "Remove from heading",
                    hint: {
                        text: "Make this task unassigned (not under any heading)"
                    }
                }), radioItems) %}
            {% endif %}
            
            {{ govukRadios({
                name: "sectionChoice",
                fieldset: {
                    legend: {
                        text: "Choose a heading for this task",
                        isPageHeading: false,
                        classes: "govuk-fieldset__legend--m"
                    }
                },
                items: radioItems
            }) }}
            
            <div class="govuk-button-group">
                {{ govukButton({
                    text: "Move task"
                }) }}
                {% if isUnassigned %}
                    <a class="govuk-link" href="/funding/grant/reports/questions?taskId={{ taskId }}&reportId={{ reportId }}&unassigned=true">Cancel</a>
                {% else %}
                    <a class="govuk-link" href="/funding/grant/reports/questions?taskId={{ taskId }}&sectionId={{ currentSectionId }}&reportId={{ reportId }}">Cancel</a>
                {% endif %}
            </div>
        </form>
    </div>
</div>
{% endblock %}